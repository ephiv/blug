<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blug</title>
    <!-- Prism.js CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #d7d7de;
            --bg-secondary: #bdbccb;
            --bg-tertiary: #f3e4d7;
            --text-primary: #1a1a1a;
            --text-secondary: #111111;
            --text-muted: #8d937f;
            --border-color: #445767;
            --border-muted: #aaa39e;
            --accent-color: #eeddff;
            --code-bg: #bdbccb;
            --code-border: #8d937f;
            --code-inline-bg: #f3e4d7;
            --syntax-bg: #f8f4f0;
            --syntax-comment: #aaa39e;
            --syntax-punctuation: #5c524c;
            --syntax-keyword: #551723;
            --syntax-string: #7a3840;
            --syntax-number: #981d34;
            --syntax-function: #7a3840;
        }

        [data-theme="dark"] {
            /* Dark theme */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #4a5568;
            --border-muted: #555555;
            --accent-color: #4a5568;
            --code-bg: #2d2d2d;
            --code-border: #4a5568;
            --code-inline-bg: #3a3a3a;
            --syntax-bg: #252525;
            --syntax-comment: #888888;
            --syntax-punctuation: #cccccc;
            --syntax-keyword: #ff6b6b;
            --syntax-string: #4ecdc4;
            --syntax-number: #feca57;
            --syntax-function: #48cae4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 40px;
            position: relative;
        }

        h1 {
            font-size: 2rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 0.9rem;
            margin-top: 10px;
            color: var(--text-secondary);
        }

        .header-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-right: 15px;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background-color: var(--accent-color);
        }

        .customize-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 5px 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .customize-btn:hover {
            background-color: var(--accent-color);
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .auth-input {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .auth-button, .create-button, .editor-button {
            padding: 5px 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .auth-button:hover, .create-button:hover, .editor-button:hover {
            background-color: var(--accent-color);
        }

        .auth-status {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .create-section {
            display: none;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        .create-section.visible {
            display: block;
        }

        .editor-container {
            display: none;
            margin-top: 20px;
        }

        .editor-container.visible {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            color: var(--text-primary);
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            flex-wrap: wrap;
        }

        .toolbar-button {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .toolbar-button:hover {
            background-color: var(--accent-color);
        }

        .editor-area {
            display: flex;
            gap: 20px;
        }

        .editor-pane, .preview-pane {
            flex: 1;
        }

        .editor-pane textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            white-space: pre-wrap;
            color: var(--text-primary);
        }

        .preview-pane {
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            padding: 15px;
            height: 300px;
            overflow-y: auto;
        }

        .preview-label, .editor-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .json-output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        .json-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            resize: vertical;
            color: var(--text-primary);
        }

        .copy-button {
            margin-top: 10px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .copy-button:hover {
            background-color: var(--accent-color);
        }

        .post-preview {
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            cursor: pointer;
            background-color: var(--bg-secondary);
        }

        .post-preview:hover {
            background-color: var(--accent-color);
        }

        .post-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .post-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .post-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .post-excerpt {
            padding: 20px 20px 20px;
            color: var(--text-secondary);
        }

        .post-content {
            display: none;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
        }

        .post-content.expanded {
            display: block;
        }

        .expand-indicator {
            float: right;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .no-posts {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            padding: 40px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        /* Markdown content styling */
        .post-content h1, .preview-pane h1,
        .post-content h2, .preview-pane h2,
        .post-content h3, .preview-pane h3,
        .post-content h4, .preview-pane h4,
        .post-content h5, .preview-pane h5,
        .post-content h6, .preview-pane h6 {
            margin: 20px 0 10px;
            font-weight: bold;
        }

        .post-content h1, .preview-pane h1 {
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .post-content h2, .preview-pane h2 {
            font-size: 1.3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
        }

        .post-content p, .preview-pane p {
            margin-bottom: 15px;
        }

        .post-content ul, .preview-pane ul,
        .post-content ol, .preview-pane ol {
            margin: 15px 0 15px 20px;
        }

        .post-content li, .preview-pane li {
            margin-bottom: 5px;
        }

        .post-content blockquote, .preview-pane blockquote {
            border-left: 3px solid var(--border-color);
            padding-left: 15px;
            margin: 15px 0;
            color: var(--text-muted);
            font-style: italic;
        }

        .post-content code, .preview-pane code {
            background-color: var(--bg-secondary);
            padding: 2px 4px;
            font-family: 'Courier New', monospace;
            border: 1px solid var(--text-muted);
        }

        .post-content pre, .preview-pane pre {
            background-color: var(--bg-secondary);
            padding: 15px;
            border: 1px solid var(--text-muted);
            overflow-x: auto;
            margin: 15px 0;
        }

        .post-content pre code, .preview-pane pre code {
            background: none;
            border: none;
            padding: 0;
        }

        .post-content a, .preview-pane a {
            color: var(--border-color);
            text-decoration: underline;
        }

        .post-content a:hover, .preview-pane a:hover {
            background-color: var(--text-primary);
            color: var(--bg-primary);
        }

        .post-content strong, .preview-pane strong {
            font-weight: bold;
        }

        .post-content em, .preview-pane em {
            font-style: italic;
        }

        .post-content hr, .preview-pane hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }

        /* Override Prism.js styles */
        code[class*="language-"],
        pre[class*="language-"] {
            color: var(--text-primary) !important;
            background: none !important;
            text-shadow: none !important;
            font-family: 'Courier New', monospace !important;
            font-size: inherit !important;
            line-height: 1.5 !important;
        }

        pre[class*="language-"] {
            padding: 15px !important;
            margin: 15px 0 !important;
            overflow: auto !important;
            background-color: var(--syntax-bg) !important;
            border: 1px solid var(--border-muted) !important;
        }

        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: var(--syntax-comment) !important;
            background: none !important;
            font-style: italic !important;
        }

        .token.punctuation {
            color: var(--syntax-punctuation) !important;
            background: none !important;
        }

        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: var(--syntax-number) !important;
            background: none !important;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: var(--syntax-string) !important;
            background: none !important;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: var(--syntax-punctuation) !important;
            background: none !important;
        }

        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: var(--syntax-keyword) !important;
            background: none !important;
            font-weight: bold !important;
        }

        .token.function,
        .token.class-name {
            color: var(--syntax-function) !important;
            background: none !important;
            font-weight: bold !important;
        }

        .token.regex,
        .token.important,
        .token.variable {
            color: var(--syntax-number) !important;
            background: none !important;
        }

        .post-content code:not([class*="language-"]),
        .preview-pane code:not([class*="language-"]) {
            background-color: var(--code-inline-bg) !important;
            color: var(--text-primary) !important;
            padding: 2px 4px !important;
            font-family: 'Courier New', monospace !important;
            border: 1px solid var(--border-muted) !important;
        }

        .post-content pre:not([class*="language-"]),
        .preview-pane pre:not([class*="language-"]) {
            background-color: var(--code-bg) !important;
            border: 1px solid var(--code-border) !important;
            padding: 15px !important;
            margin: 15px 0 !important;
            overflow-x: auto !important;
        }

        .post-content pre:not([class*="language-"]) code,
        .preview-pane pre:not([class*="language-"]) code {
            background: none !important;
            border: none !important;
            padding: 0 !important;
            color: var(--text-primary) !important;
        }

        .code-block {
            position: relative;
        }

        .copy-code-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            color: var(--text-primary);
        }

        .code-block:hover .copy-code-btn {
            opacity: 1;
        }

        .post-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .post-controls input,
        .post-controls select {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .regex-highlight {
            background-color: var(--accent-color);
            color: var(--text-primary);
            padding: 0 2px;
        }
        [data-theme="dark"] .regex-highlight {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }


        .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }

        .error {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        /* Theme Customizer Modal */
        .theme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .theme-modal.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-modal-content {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .theme-modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .theme-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .theme-tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
        }

        .theme-tab.active {
            background: var(--accent-color);
        }

        .theme-section {
            display: none;
        }

        .theme-section.active {
            display: block;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .color-field label {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .color-input-group {
            display: flex;
            gap: 5px;
        }

        .color-input-group input[type="color"] {
            width: 40px;
            height: 30px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .color-input-group input[type="text"] {
            flex: 1;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .theme-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .theme-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .theme-btn:hover {
            background: var(--accent-color);
        }

        .theme-preview {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .preview-sample {
            margin-bottom: 15px;
        }

        .preview-sample h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .preview-sample p {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .preview-sample code {
            background: var(--code-inline-bg);
            padding: 2px 4px;
            color: var(--text-primary);
        }

        .preview-sample pre {
            background: var(--syntax-bg);
            padding: 10px;
            border: 1px solid var(--border-muted);
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .header-controls {
                position: static;
                margin-top: 20px;
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .editor-area {
                flex-direction: column;
            }

            .theme-modal-content {
                margin: 20px;
                padding: 20px;
            }

            .color-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>blug</h1>
            <p class="subtitle">a minimal blog (im too lazy to make a real one)</p>

            <div class="header-controls">
                <div class="theme-controls">
                    <button id="theme-toggle" class="theme-toggle">🌙</button>
                    <button id="customize-theme" class="customize-btn">🎨</button>
                </div>

                <div class="auth-section">
                    <div id="auth-form">
                        <input type="password" id="password-input" class="auth-input" placeholder="enter password">
                        <button id="auth-button" class="auth-button">login</button>
                    </div>
                    <div id="auth-status" class="auth-status" style="display: none;"></div>
                </div>
            </div>
        </header>

        <div id="create-section" class="create-section">
            <h3>create new post</h3>
            <button id="toggle-editor" class="create-button">start writing</button>

            <div id="editor-container" class="editor-container">
                <div class="form-group">
                    <label class="form-label" for="post-id">id:</label>
                    <input type="text" id="post-id" class="form-input" placeholder="enter post id (or leave blank for auto)">
                </div>

                <div class="form-group">
                    <label class="form-label" for="post-title">title:</label>
                    <input type="text" id="post-title" class="form-input" placeholder="enter post title">
                </div>

                <div class="form-group">
                    <label class="form-label" for="post-excerpt">excerpt:</label>
                    <textarea id="post-excerpt" class="form-textarea" placeholder="brief preview of your post..."></textarea>
                </div>

                <div class="editor-toolbar">
                    <button class="toolbar-button" data-action="bold">**bold**</button>
                    <button class="toolbar-button" data-action="italic">*italic*</button>
                    <button class="toolbar-button" data-action="strikethrough">~~strike~~</button>
                    <button class="toolbar-button" data-action="code">`code`</button>
                    <button class="toolbar-button" data-action="link">[link](url)</button>
                    <button class="toolbar-button" data-action="h1"># h1</button>
                    <button class="toolbar-button" data-action="h2">## h2</button>
                    <button class="toolbar-button" data-action="quote">> quote</button>
                    <button class="toolbar-button" data-action="list">- list</button>
                    <button class="toolbar-button" data-action="codeblock">```code```</button>
                </div>

                <div class="editor-area">
                    <div class="editor-pane">
                        <label class="editor-label">markdown editor:</label>
                        <textarea id="markdown-editor" placeholder="write your post in markdown..."></textarea>
                    </div>
                    <div class="preview-pane">
                        <label class="preview-label">live preview:</label>
                        <div id="markdown-preview"></div>
                    </div>
                </div>

                <div class="json-output">
                    <h4>generated json (copy this to add to posts.json):</h4>
                    <textarea id="json-output" class="json-textarea" readonly></textarea>
                    <button id="copy-json" class="copy-button">copy to clipboard</button>
                </div>
            </div>
        </div>

        <div id="post-controls" class="post-controls">
            <input type="text" id="search-input" placeholder="Search posts...">
            <input type="text" id="regex-input" placeholder="Regex search...">
            <select id="filter-date">
                <option value="">All dates</option>
            </select>
            <select id="sort-order">
                <option value="asc">Oldest first</option>
                <option value="desc">Newest first</option>
            </select>
        </div>

        <main id="blog-posts">
            <div class="loading">...</div>
        </main>
    </div>

    <!-- Theme Customizer Modal -->
    <div id="theme-modal" class="theme-modal">
        <div class="theme-modal-content">
            <h2>Customize Themes</h2>

            <div class="theme-tabs">
                <button class="theme-tab active" data-theme="light">Light Theme</button>
                <button class="theme-tab" data-theme="dark">Dark Theme</button>
            </div>

            <div id="light-theme-section" class="theme-section active">
                <h3>Light Theme Colors</h3>
                <div class="color-grid" id="light-color-grid">
                    <!-- Color inputs will be generated here -->
                </div>
            </div>

            <div id="dark-theme-section" class="theme-section">
                <h3>Dark Theme Colors</h3>
                <div class="color-grid" id="dark-color-grid">
                    <!-- Color inputs will be generated here -->
                </div>
            </div>

            <div class="theme-preview">
                <h3>Preview</h3>
                <div class="preview-sample">
                    <h3>Sample Heading</h3>
                    <p>This is some sample text to preview your theme. <code>inline code</code></p>
                    <pre><code class="language-python">
                    def hello_world():
                        print("Hello, World!")

                    hello_world()
                    </code></pre>
                </div>
            </div>

            <div class="theme-actions">
                <button class="theme-btn" id="reset-theme">Reset to Default</button>
                <button class="theme-btn" id="apply-theme">Apply & Save</button>
                <button class="theme-btn" id="close-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Prism.js script for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']]
        },
        svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js" async></script>



    <script type="module">
        import { marked } from 'https://cdnjs.cloudflare.com/ajax/libs/marked/16.2.0/lib/marked.esm.js';

        // Simple password (change this to whatever you want)
        const OWNER_PASSWORD = 'pascalstriangle35601111';

        let isAuthenticated = false;
        let posts = [];
        let currentTheme = 'light';

        // Default theme palettes
        const defaultThemes = {
            light: {
                'bg-primary': '#d7d7de',
                'bg-secondary': '#bdbccb',
                'bg-tertiary': '#f3e4d7',
                'text-primary': '#1a1a1a',
                'text-secondary': '#111111',
                'text-muted': '#8d937f',
                'border-color': '#445767',
                'border-muted': '#aaa39e',
                'accent-color': '#eeddff',
                'code-bg': '#bdbccb',
                'code-border': '#8d937f',
                'code-inline-bg': '#f3e4d7',
                'syntax-bg': '#f8f4f0',
                'syntax-comment': '#aaa39e',
                'syntax-punctuation': '#5c524c',
                'syntax-keyword': '#551723',
                'syntax-string': '#7a3840',
                'syntax-number': '#981d34',
                'syntax-function': '#7a3840'
            },
            dark: {
                'bg-primary': '#1a1a1a',
                'bg-secondary': '#2d2d2d',
                'bg-tertiary': '#3a3a3a',
                'text-primary': '#e0e0e0',
                'text-secondary': '#cccccc',
                'text-muted': '#888888',
                'border-color': '#4a5568',
                'border-muted': '#555555',
                'accent-color': '#4a5568',
                'code-bg': '#2d2d2d',
                'code-border': '#4a5568',
                'code-inline-bg': '#3a3a3a',
                'syntax-bg': '#252525',
                'syntax-comment': '#888888',
                'syntax-punctuation': '#cccccc',
                'syntax-keyword': '#ff6b6b',
                'syntax-string': '#4ecdc4',
                'syntax-number': '#feca57',
                'syntax-function': '#48cae4'
            }
        };

        // Color field configurations
        const colorFields = [
            { key: 'bg-primary', label: 'Primary Background', category: 'backgrounds' },
            { key: 'bg-secondary', label: 'Secondary Background', category: 'backgrounds' },
            { key: 'bg-tertiary', label: 'Tertiary Background', category: 'backgrounds' },
            { key: 'text-primary', label: 'Primary Text', category: 'text' },
            { key: 'text-secondary', label: 'Secondary Text', category: 'text' },
            { key: 'text-muted', label: 'Muted Text', category: 'text' },
            { key: 'border-color', label: 'Primary Border', category: 'borders' },
            { key: 'border-muted', label: 'Muted Border', category: 'borders' },
            { key: 'accent-color', label: 'Accent/Hover', category: 'accents' },
            { key: 'code-bg', label: 'Code Background', category: 'code' },
            { key: 'code-border', label: 'Code Border', category: 'code' },
            { key: 'code-inline-bg', label: 'Inline Code Background', category: 'code' },
            { key: 'syntax-bg', label: 'Syntax Highlight Background', category: 'syntax' },
            { key: 'syntax-comment', label: 'Comments', category: 'syntax' },
            { key: 'syntax-punctuation', label: 'Punctuation', category: 'syntax' },
            { key: 'syntax-keyword', label: 'Keywords', category: 'syntax' },
            { key: 'syntax-string', label: 'Strings', category: 'syntax' },
            { key: 'syntax-number', label: 'Numbers', category: 'syntax' },
            { key: 'syntax-function', label: 'Functions', category: 'syntax' }
        ];

        // DOM elements
        const passwordInput = document.getElementById('password-input');
        const authButton = document.getElementById('auth-button');
        const authForm = document.getElementById('auth-form');
        const authStatus = document.getElementById('auth-status');
        const createSection = document.getElementById('create-section');
        const toggleEditorBtn = document.getElementById('toggle-editor');
        const editorContainer = document.getElementById('editor-container');
        const postsContainer = document.getElementById('blog-posts');
        const themeToggle = document.getElementById('theme-toggle');
        const customizeTheme = document.getElementById('customize-theme');
        const themeModal = document.getElementById('theme-modal');

        // Editor elements
        const postIdInput = document.getElementById('post-id');
        const postTitleInput = document.getElementById('post-title');
        const postExcerptInput = document.getElementById('post-excerpt');
        const markdownEditor = document.getElementById('markdown-editor');
        const markdownPreview = document.getElementById('markdown-preview');
        const jsonOutput = document.getElementById('json-output');
        const copyJsonBtn = document.getElementById('copy-json');

        // Theme initialization
        function initializeThemes() {
            // Load saved theme and customizations
            const savedTheme = localStorage.getItem('blug-theme') || 'light';
            const savedCustomizations = JSON.parse(localStorage.getItem('blug-custom-themes')) || {};

            // Merge saved customizations with defaults
            Object.keys(defaultThemes).forEach(themeKey => {
                if (savedCustomizations[themeKey]) {
                    Object.assign(defaultThemes[themeKey], savedCustomizations[themeKey]);
                }
            });

            currentTheme = savedTheme;
            applyTheme(currentTheme);
            updateThemeToggleIcon();
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const colors = defaultThemes[theme];

            Object.entries(colors).forEach(([key, value]) => {
                document.documentElement.style.setProperty(`--${key}`, value);
            });

            currentTheme = theme;
            localStorage.setItem('blug-theme', theme);
        }

        function updateThemeToggleIcon() {
            themeToggle.textContent = currentTheme === 'light' ? '🌙' : '☀️';
        }

        // Theme toggle functionality
        themeToggle.addEventListener('click', () => {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            updateThemeToggleIcon();
        });

        // Theme customizer modal
        customizeTheme.addEventListener('click', () => {
            openThemeCustomizer();
        });

        function openThemeCustomizer() {
            themeModal.classList.add('visible');
            generateColorFields();
            populateCurrentValues();
        }

        function generateColorFields() {
            const lightGrid = document.getElementById('light-color-grid');
            const darkGrid = document.getElementById('dark-color-grid');

            lightGrid.innerHTML = '';
            darkGrid.innerHTML = '';

            colorFields.forEach(field => {
                const lightField = createColorField(field, 'light');
                const darkField = createColorField(field, 'dark');
                lightGrid.appendChild(lightField);
                darkGrid.appendChild(darkField);
            });
        }

        function createColorField(field, theme) {
            const div = document.createElement('div');
            div.className = 'color-field';

            const currentColor = defaultThemes[theme][field.key];

            div.innerHTML = `
                <label>${field.label}</label>
                <div class="color-input-group">
                    <input type="color" value="${currentColor}" data-theme="${theme}" data-key="${field.key}">
                    <input type="text" value="${currentColor}" data-theme="${theme}" data-key="${field.key}">
                </div>
            `;

            // Add event listeners
            const colorInput = div.querySelector('input[type="color"]');
            const textInput = div.querySelector('input[type="text"]');

            colorInput.addEventListener('input', (e) => {
                textInput.value = e.target.value;
                updateThemePreview();
            });

            textInput.addEventListener('input', (e) => {
                if (isValidColor(e.target.value)) {
                    colorInput.value = e.target.value;
                    updateThemePreview();
                }
            });

            return div;
        }

        function populateCurrentValues() {
            ['light', 'dark'].forEach(theme => {
                colorFields.forEach(field => {
                    const colorInput = document.querySelector(`input[type="color"][data-theme="${theme}"][data-key="${field.key}"]`);
                    const textInput = document.querySelector(`input[type="text"][data-theme="${theme}"][data-key="${field.key}"]`);

                    if (colorInput && textInput) {
                        const currentValue = defaultThemes[theme][field.key];
                        colorInput.value = currentValue;
                        textInput.value = currentValue;
                    }
                });
            });
        }

        function updateThemePreview() {
            // Get current values from the active tab
            const activeTab = document.querySelector('.theme-tab.active').dataset.theme;
            const tempTheme = {};

            colorFields.forEach(field => {
                const textInput = document.querySelector(`input[type="text"][data-theme="${activeTab}"][data-key="${field.key}"]`);
                if (textInput && isValidColor(textInput.value)) {
                    tempTheme[field.key] = textInput.value;
                }
            });

            // Apply preview (only if viewing the current active theme)
            if (activeTab === currentTheme) {
                Object.entries(tempTheme).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(`--${key}`, value);
                });
            }
        }

        function isValidColor(color) {
            const s = new Option().style;
            s.color = color;
            return s.color !== '';
        }

        // Theme tab switching
        document.addEventListener('click', (e) => {
            if (e.target.matches('.theme-tab')) {
                document.querySelectorAll('.theme-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.theme-section').forEach(section => section.classList.remove('active'));

                e.target.classList.add('active');
                const themeType = e.target.dataset.theme;
                document.getElementById(`${themeType}-theme-section`).classList.add('active');

                updateThemePreview();
            }
        });

        // Theme customizer actions
        document.getElementById('apply-theme').addEventListener('click', () => {
            saveCurrentCustomizations();
            themeModal.classList.remove('visible');
        });

        document.getElementById('reset-theme').addEventListener('click', () => {
            if (confirm('Reset current theme to default? This will lose your customizations.')) {
                const activeTab = document.querySelector('.theme-tab.active').dataset.theme;

                // Reset to original default
                const originalDefaults = {
                    light: {
                        'bg-primary': '#d7d7de',
                        'bg-secondary': '#bdbccb',
                        'bg-tertiary': '#f3e4d7',
                        'text-primary': '#1a1a1a',
                        'text-secondary': '#111111',
                        'text-muted': '#8d937f',
                        'border-color': '#445767',
                        'border-muted': '#aaa39e',
                        'accent-color': '#eeddff',
                        'code-bg': '#bdbccb',
                        'code-border': '#8d937f',
                        'code-inline-bg': '#f3e4d7',
                        'syntax-bg': '#f8f4f0',
                        'syntax-comment': '#aaa39e',
                        'syntax-punctuation': '#5c524c',
                        'syntax-keyword': '#551723',
                        'syntax-string': '#7a3840',
                        'syntax-number': '#981d34',
                        'syntax-function': '#7a3840'
                    },
                    dark: {
                        'bg-primary': '#1a1a1a',
                        'bg-secondary': '#2d2d2d',
                        'bg-tertiary': '#3a3a3a',
                        'text-primary': '#e0e0e0',
                        'text-secondary': '#cccccc',
                        'text-muted': '#888888',
                        'border-color': '#4a5568',
                        'border-muted': '#555555',
                        'accent-color': '#4a5568',
                        'code-bg': '#2d2d2d',
                        'code-border': '#4a5568',
                        'code-inline-bg': '#3a3a3a',
                        'syntax-bg': '#252525',
                        'syntax-comment': '#888888',
                        'syntax-punctuation': '#cccccc',
                        'syntax-keyword': '#ff6b6b',
                        'syntax-string': '#4ecdc4',
                        'syntax-number': '#feca57',
                        'syntax-function': '#48cae4'
                    }
                };

                defaultThemes[activeTab] = { ...originalDefaults[activeTab] };
                populateCurrentValues();
                updateThemePreview();
            }
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            themeModal.classList.remove('visible');
            // Revert to saved theme
            applyTheme(currentTheme);
        });

        // Close modal when clicking outside
        themeModal.addEventListener('click', (e) => {
            if (e.target === themeModal) {
                document.getElementById('close-modal').click();
            }
        });

        function saveCurrentCustomizations() {
            const customizations = {};

            ['light', 'dark'].forEach(theme => {
                customizations[theme] = {};
                colorFields.forEach(field => {
                    const textInput = document.querySelector(`input[type="text"][data-theme="${theme}"][data-key="${field.key}"]`);
                    if (textInput && isValidColor(textInput.value)) {
                        customizations[theme][field.key] = textInput.value;
                        defaultThemes[theme][field.key] = textInput.value;
                    }
                });
            });

            localStorage.setItem('blug-custom-themes', JSON.stringify(customizations));
            applyTheme(currentTheme);
        }

        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Authentication
        authButton.addEventListener('click', handleAuth);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuth();
        });

        function handleAuth() {
            const password = passwordInput.value;

            if (password === OWNER_PASSWORD) {
                isAuthenticated = true;
                authForm.style.display = 'none';
                authStatus.style.display = 'block';
                authStatus.textContent = 'authenticated as owner';
                createSection.classList.add('visible');
            } else {
                alert('incorrect password');
                passwordInput.value = '';
            }
        }

        // Editor functionality
        toggleEditorBtn.addEventListener('click', () => {
            editorContainer.classList.toggle('visible');
            toggleEditorBtn.textContent = editorContainer.classList.contains('visible')
                ? 'hide editor' : 'start writing';
        });

        // Toolbar buttons
        document.querySelectorAll('.toolbar-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                insertMarkdown(action);
            });
        });

        function insertMarkdown(action) {
            const editor = markdownEditor;
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            let replacement = '';

            switch (action) {
                case 'bold':
                    replacement = `**${selectedText || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText || 'italic text'}*`;
                    break;
                case 'strikethrough':
                    replacement = `~~${selectedText || 'strikethrough text'}~~`;
                    break;
                case 'code':
                    replacement = `\`${selectedText || 'code'}\``;
                    break;
                case 'link':
                    replacement = `[${selectedText || 'link text'}](url)`;
                    break;
                case 'h1':
                    replacement = `# ${selectedText || 'heading'}`;
                    break;
                case 'h2':
                    replacement = `## ${selectedText || 'heading'}`;
                    break;
                case 'quote':
                    replacement = `> ${selectedText || 'quote'}`;
                    break;
                case 'list':
                    replacement = `- ${selectedText || 'list item'}`;
                    break;
                case 'codeblock':
                    replacement = `\`\`\`\n${selectedText || 'code here'}\n\`\`\``;
                    break;
            }

            editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
            editor.focus();

            // Update preview
            updatePreview();
        }

        // Live preview update
        markdownEditor.addEventListener('input', updatePreview);
        postIdInput.addEventListener('input', updateJsonOutput);
        postTitleInput.addEventListener('input', updateJsonOutput);
        postExcerptInput.addEventListener('input', updateJsonOutput);

        function updatePreview() {
            const markdown = markdownEditor.value;

            markdownPreview.innerHTML = marked.parse(markdown);
            // Apply syntax highlighting to preview with a small delay
            setTimeout(() => {
                Prism.highlightAllUnder(markdownPreview);
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([markdownPreview]).catch((err) => console.error('MathJax preview error:', err));
                }

            }, 50);
            updateJsonOutput();
        }

        function updateJsonOutput() {
            const customId = postIdInput.value.trim();
            const title = postTitleInput.value.trim();
            const excerpt = postExcerptInput.value.trim();
            const content = markdownEditor.value.trim();

            if (!title && !excerpt && !content) {
                jsonOutput.value = '';
                return;
            }

            const postId = customId || generateId();
            const currentDate = new Date().toISOString().split('T')[0];

            const postObject = {
                id: postId,
                title: title || 'untitled post',
                date: currentDate,
                excerpt: excerpt || 'no excerpt provided',
                content: content || '# empty post\n\nno content yet...'
            };

            jsonOutput.value = JSON.stringify(postObject, null, 2);
        }

        function generateId() {
            const maxId = posts.length > 0 ? Math.max(...posts.map(p => parseInt(p.id))) : 0;
            return (maxId + 1).toString();
        }

        // Copy to clipboard
        copyJsonBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(jsonOutput.value);
                const originalText = copyJsonBtn.textContent;
                copyJsonBtn.textContent = 'copied!';
                setTimeout(() => {
                    copyJsonBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                alert('failed to copy to clipboard');
            }
        });

        // Blog posts functionality
        async function loadPosts() {
            try {
                const response = await fetch('./posts.json');

                if (!response.ok) {
                    throw new Error('Failed to load posts');
                }

                posts = await response.json();
                populateFilterOptions(posts);
                applyFilters();

                renderPosts(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
                showError();
            }
        }

        function applyFilters() {
            clearRegexHighlights();
            regexInput.value = ''; // also reset the regex box when doing normal search

            let query = searchInput.value.trim().toLowerCase();
            const filterValue = filterDate.value;
            const order = sortOrder.value;


            let filtered = posts.filter(post => {
                if (query.startsWith('id=')) {
                    const targetId = query.replace(/^id=#?/, '').trim();
                    if (post.id.toLowerCase() !== targetId) return false;
                } else if (query) {
                    const haystack = (post.title + ' ' + post.excerpt + ' ' + post.content).toLowerCase();
                    if (!haystack.includes(query)) return false;
                }

                if (filterValue) {
                    const postMonth = post.date.slice(0,7);
                    if (!postMonth.startsWith(filterValue)) return false;
                }

                return true;
            });

            filtered.sort((a, b) => {
                if (order === 'asc') {
                    return new Date(a.date) - new Date(b.date);
                } else {
                    return new Date(b.date) - new Date(a.date);
                }
            });

            renderPosts(filtered);
        }

        function populateFilterOptions(posts) {
            const months = new Set(posts.map(p => p.date.slice(0,7)));
            const sortedMonths = Array.from(months).sort().reverse();

            sortedMonths.forEach(month => {
                const [year, m] = month.split('-');
                const label = new Date(`${month}-01`).toLocaleDateString('en-US', { year:'numeric', month:'long' });
                const opt = document.createElement('option');
                opt.value = month;
                opt.textContent = label;
                filterDate.appendChild(opt);
            });
        }

        const searchInput = document.getElementById('search-input');
        const filterDate = document.getElementById('filter-date');
        const sortOrder = document.getElementById('sort-order');

        searchInput.addEventListener('input', applyFilters);
        filterDate.addEventListener('change', applyFilters);
        sortOrder.addEventListener('change', applyFilters);

        const regexInput = document.getElementById('regex-input');
        regexInput.addEventListener('input', applyRegexSearch);

        function applyRegexSearch() {
            const pattern = regexInput.value.trim();
            if (!pattern) {
                // clear highlights and just reapply normal search
                clearRegexHighlights();
                applyFilters();
                return;
            }

            let regex;
            try {
                regex = new RegExp(pattern, 'gi');
            } catch (e) {
                console.error('Invalid regex:', e);
                return;
            }

            const matchedPosts = posts.filter(post =>
                regex.test(post.title) || regex.test(post.excerpt) || regex.test(post.content)
            );

            renderPosts(matchedPosts);

            // Highlight matches in rendered HTML
            highlightRegexInContainer(regex, postsContainer);
        }

        function clearRegexHighlights() {
            postsContainer.querySelectorAll('.regex-highlight').forEach(el => {
                el.replaceWith(el.textContent);
            });
        }

        function highlightRegexInContainer(regex, container) {
            // Walk through elements we care about: title, excerpt, content
            ['.post-title', '.post-excerpt', '.post-content'].forEach(selector => {
                container.querySelectorAll(selector).forEach(el => {
                    highlightText(el, regex);
                });
            });
        }

        function highlightText(element, regex) {
            // Walk text nodes only
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);

            textNodes.forEach(node => {
                const parent = node.parentNode;
                if (!regex.test(node.nodeValue)) return;

                const frag = document.createDocumentFragment();
                let lastIndex = 0;
                node.nodeValue.replace(regex, (match, offset) => {
                    // add text before
                    if (offset > lastIndex) {
                        frag.appendChild(document.createTextNode(node.nodeValue.slice(lastIndex, offset)));
                    }
                    // add highlighted span
                    const span = document.createElement('span');
                    span.className = 'regex-highlight';
                    span.textContent = match;
                    frag.appendChild(span);
                    lastIndex = offset + match.length;
                });
                // add tail
                if (lastIndex < node.nodeValue.length) {
                    frag.appendChild(document.createTextNode(node.nodeValue.slice(lastIndex)));
                }
                parent.replaceChild(frag, node);
            });
        }


        function renderPosts(posts) {
            if (!posts || posts.length === 0) {
                showNoPosts();
                return;
            }

            const postsHtml = posts.map(post => createPostHTML(post)).join('');
            postsContainer.innerHTML = postsHtml;

            // Add copy buttons to each code block
            postsContainer.querySelectorAll('pre code').forEach(codeEl => {
                const pre = codeEl.parentElement;
                if (!pre.classList.contains('has-copy')) {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('code-block');
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    const button = document.createElement('button');
                    button.className = 'copy-code-btn';
                    button.innerHTML = '📋';
                    wrapper.appendChild(button);

                    button.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(codeEl.textContent);
                            button.innerHTML = '✅';
                            setTimeout(() => button.innerHTML = '📋', 2000);
                        } catch {
                            button.innerHTML = '❌';
                            setTimeout(() => button.innerHTML = '📋', 2000);
                        }
                    });

                    pre.classList.add('has-copy');
                }
            });

            setTimeout(() => {
                if (window.MathJax) {
                    MathJax.typesetPromise([postsContainer]);
                }
                Prism.highlightAllUnder(postsContainer);
            }, 100);

            document.querySelectorAll('.post-preview .post-header, .post-preview .post-excerpt')
                .forEach(el => {
                    el.addEventListener('click', (e) => {
                        const preview = e.currentTarget.closest('.post-preview');
                        togglePost(preview);
                    });
                });
        }

        function createPostHTML(post) {
            const date = new Date(post.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return `
                <article class="post-preview" data-id="${post.id}">
                    <div class="post-header">
                        <h2 class="post-title">${escapeHtml(post.title)}</h2>
                        <div class="post-date">${date}</div>
                        <span class="expand-indicator">+</span>
                    </div>
                    <div class="post-excerpt">
                        ${escapeHtml(post.excerpt)}
                    </div>
                    <div class="post-content" id="content-${post.id}">
                        ${marked.parse(post.content)}
                    </div>
                </article>
            `;
        }

        function togglePost(preview) {
            const content = preview.querySelector('.post-content');
            const indicator = preview.querySelector('.expand-indicator');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                indicator.textContent = '+';
            } else {
                content.classList.add('expanded');
                indicator.textContent = '−';
                Prism.highlightAllUnder(content);
            }
        }

        function showNoPosts() {
            postsContainer.innerHTML = `
                <div class="no-posts">
                    No posts available. Create a posts.json file with your blog posts.
                </div>
            `;
        }

        function showError() {
            postsContainer.innerHTML = `
                <div class="error">
                    <h3>Unable to load posts</h3>
                    <p>Make sure posts.json exists in the same directory as this HTML file.</p>
                    <p>Example posts.json structure:</p>
                    <pre>[
  {
    "id": "1",
    "title": "My First Post",
    "date": "2025-08-23",
    "excerpt": "This is a preview of my first post...",
    "content": "# Hello World\\n\\nThis is my **first** blog post!"
  }
]</pre>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize themes and load posts
        initializeThemes();
        loadPosts();
    </script>
</body>
</html>
